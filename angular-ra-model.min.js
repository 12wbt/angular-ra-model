"use strict";angular.module("ra.model",["ra.model.services"]),function(){function a(a){var b=a.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",");return 1!==b.length||b[0]?b:[]}function b(a){return angular.forEach(Array.prototype.slice.call(arguments,1),function(b){if(a&&b)for(var c in b)a[c]=b[c]}),a}angular.module("ra.model.services",[]).run(["$rootScope","raModel",function(a,b){a.model=function(a,c){var d=new b(this,a,c);return this[a]=d,d}}]).factory("raModel",["$rootScope","$cacheFactory","$location","$q",function(c,d,e,f){var g=d("raModel"),h=function i(a,b,d){if(!(this instanceof i))return new i(a,b,d);var e=Array.prototype.slice.call(arguments);angular.isObject(e[0])||e[0]===!1||e.unshift(c),a=e[0],b=e[1],d=e[2]||{},this.extend(d),this.name=b,this.is=d.is||{},this.opts=d.opts||{},this.attr_accessible=d.attr_accessible||[],this.attr_protected=d.attr_protected||[],this.resource_attribute=d.resource_attribute||"items",this._scope=function(){return a}};return h.prototype.init=function(a){angular.isFunction(this.beforeInit)&&this.beforeInit(a);var b=this.get(a);return angular.isFunction(this.afterInit)&&this.afterInit(b,a),this.is.inited=!0,b},h.prototype.get=function(a){if(this.opts.cache){var b=this.cached();if(b)return f.when(b).then(function(){this.success(b)}.bind(this)),b}var c,d,e=[];if(this.params&&(d=angular.isFunction(this.params)?this.params():this.params),e.push(angular.extend({},d,a),this._setHeaders.bind(this)),this.resource){var g=this.resource,h=this;this.resource_method&&(g=g[this.resource_method],h=this.resource),c=g.apply(h,e),c&&c.$promise&&(this.$promise=c.$promise.then(this.success.bind(this),this.error.bind(this)))}else angular.isFunction(this.config.get)&&(c=this.config.get.apply(this,e));return this.is.loading=!0,c},h.prototype.update=function(){var a=f.defer(),b=function(b){angular.isFunction(this.updateSuccess)&&this.updateSuccess(b),this.is.updating=!1,this.is.processing=!1,this.snapshot(),this._scope()&&(this._scope().$broadcast(this.name+":updateComplete",b),this._scope().$broadcast(this.name+":updateSuccess",b)),a.resolve(b)},c=function(b){angular.isFunction(this.updateError)&&this.updateError(b),this.is.updating=!1,this.is.processing=!1,this._scope()&&(this._scope().$broadcast(this.name+":updateComplete",b),this._scope().$broadcast(this.name+":updateError",b)),a.reject(b)};return angular.isFunction(this.$update)&&(this.is.updating=!0,this.is.processing=!0,this.$update.call(this.getData(),b.bind(this),c.bind(this))),a.promise},h.prototype.success=function(a){return this._setAttrs(a),this.resource_set!==!1&&(angular.isArray(a)?this[this.resource_attribute]=a:b(this,a)),this.is.loaded=!0,this.is.loading=!1,angular.isFunction(this.config.success)&&this.config.success.call(this,a,this.$headers),this.snapshot(),this.opts.cache&&this.opts.cache.set!==!1&&this.cache(a),this._scope()&&(this._scope().$broadcast(this.name+":success",a,this.$headers),this._scope().$broadcast(this.name+":complete",a,this.$headers)),a},h.prototype.error=function(a){return this.is.loaded=!0,this.is.loading=!1,angular.isFunction(this.config.error)&&this.config.error.call(this,a),this._scope()&&(this._scope().$broadcast(this.name+":error",a),this._scope().$broadcast(this.name+":complete",a)),f.reject(a)},h.prototype.cache=function(a,b){g.put(this._cacheKey(b),a)},h.prototype.cached=function(a){return g.get(this._cacheKey(a))},h.prototype.snapshot=function(){this._original=this.getData()},h.prototype.reset=function(){angular.isArray(this._original)?angular.forEach(this[this.resource_attribute],function(a){for(var b=0,c=this._original.length;c>b;b++)if(angular.isObject(a)&&angular.isObject(this._original[b])&&a.id===this._original[b].id){angular.extend(a,angular.copy(this._original[b]));break}}.bind(this)):angular.extend(this,angular.copy(this._original))},h.prototype.flush=function(a){g.remove(this._cacheKey(a))},h.prototype.extend=function(c){var d=this;c=c||{},this.config?b(this.config,c):this.config=c;for(var e in c){var f=c[e];if(angular.isFunction(f))if("$super"===a(f)[0]){var g=this[e],i=angular.copy(f);f=function(){var a=Array.prototype.slice.call(arguments,0);return a.unshift(g.bind(d)),i.apply(d,a)},this[e]=f}else(angular.isUndefined(h.prototype[e])||angular.isDefined(h.prototype[e])&&h.prototype[e]===Object.prototype[e])&&(this[e]=f);else this[e]=f}},h.prototype.data=h.prototype.getData=function(){var a,b=this;return angular.isArray(b[b.resource_attribute])?(a=[],angular.forEach(b[b.resource_attribute],function(c){var d={};angular.forEach(b._getAttrs(),function(a){a in c&&(d[a]=angular.copy(c[a]))}),a.push(d)})):(a={},angular.forEach(b._getAttrs(),function(c){c in b&&(a[c]=angular.copy(b[c]))})),a},h.prototype._setHeaders=function(a,b){this.$headers=b,this.$headers.parse=function(a){return angular.fromJson(this(a))}},h.prototype._setAttrs=function(a){var b;if(b=angular.isArray(a)&&a.length>0?a[0]:a,angular.isObject(b)){this._attrs=[];var c=Object.keys(b).concat(this.attr_accessible),d=this;angular.forEach(c,function(a){if(a){var b=a.charAt(0);"$"!==b&&"_"!==b&&-1===d._attrs.indexOf(a)&&-1===d.attr_protected.indexOf(a)&&d._attrs.push(a)}})}},h.prototype._getAttrs=function(){return angular.isArray(this._attrs)&&this._attrs.length>0?this._attrs:angular.isArray(this.attr_accessible)&&this.attr_accessible.length>0?this.attr_accessible:[]},h.prototype._cacheKey=function(a){var b=[];return b.push(a?a:this.opts.cache.key!==!0?this.opts.cache.key:e.path()),b.push(this.name),b.join("|")},h}])}();